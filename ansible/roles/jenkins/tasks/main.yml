---
- name: Make sure we have a 'wheel' group
  group:
    name: wheel
    state: present

- name: Allow 'wheel' group to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^%wheel'
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'

- name: Add the user jenkins
  ansible.builtin.user:
    name: jenkins
    groups: wheel
    append: yes
    create_home: yes
    shell: /bin/bash

- name: Upgrade apt packages
  apt:
    upgrade: full
    update_cache: yes

- name: Install basic packages
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
    cache_valid_time: 7200
  loop:
    - gpg
    - vim
    - ca-certificates

- name: Copy source file
  ansible.builtin.copy:
    src: files/jenkins.list
    dest: /etc/apt/sources.list.d/jenkins.list
    owner: root
    group: root
    mode: 0644

- name: Add apt key
  ansible.builtin.apt_key:
    url: https://pkg.jenkins.io/debian/jenkins.io.key
    state: present

- name: Install Jenkins
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - openjdk-11-jdk
    - jenkins
  environment:
    HTTP_PROXY: http://192.168.3.1:8889
    HTTPS_PROXY: http://192.168.3.1:8889
